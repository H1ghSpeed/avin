use avin_core::{Bar, Chart, Manager, TimeFrame};

fn main() {
    // 1M
    // Bar: dt=2025-01-03 09:59:00 o=280 h=280 l=280 c=280 v=158150
    // Bar: dt=2025-01-03 10:00:00 o=279.99 h=280 l=279.55 c=279.7 v=476620
    // Bar: dt=2025-01-03 10:01:00 o=279.64 h=279.9 l=279.2 c=279.85 v=643880
    // Bar: dt=2025-01-03 10:02:00 o=279.85 h=280.41 l=279.74 c=280.1 v=584470
    // Bar: dt=2025-01-03 10:03:00 o=280.17 h=280.2 l=279.87 c=279.9 v=369760
    // Bar: dt=2025-01-03 10:04:00 o=279.9 h=279.95 l=279.54 c=279.54 v=338140
    // Bar: dt=2025-01-03 10:05:00 o=279.54 h=279.56 l=279 c=279.44 v=767470
    // Bar: dt=2025-01-03 10:06:00 o=279.43 h=279.44 l=278.58 c=278.91 v=520310
    // Bar: dt=2025-01-03 10:07:00 o=278.99 h=279.38 l=278.71 c=279.07 v=281490
    // Bar: dt=2025-01-03 10:08:00 o=279.07 h=279.07 l=278.11 c=278.31 v=304020
    // Bar: dt=2025-01-03 10:09:00 o=278.34 h=278.91 l=278.15 c=278.4 v=416040
    // Bar: dt=2025-01-03 10:10:00 o=278.53 h=278.89 l=278.14 c=278.62 v=233030
    // Bar: dt=2025-01-03 10:11:00 o=278.62 h=278.93 l=278.58 c=278.93 v=164140
    // Bar: dt=2025-01-03 10:12:00 o=278.91 h=279.21 l=278.85 c=278.86 v=208890
    // Bar: dt=2025-01-03 10:13:00 o=278.86 h=278.88 l=278.51 c=278.73 v=153850
    // ---> Day
    // Bar: dt=2025-01-03 09:59:00 o=280 h=280.41 l=278.11 c=278.73 v=5620260

    let iid = Manager::find_iid("moex_share_sber").unwrap();
    let tf = TimeFrame::Day;
    let mut chart = Chart::empty(&iid, tf);

    let bars_data = bars();
    for b in bars_data.iter() {
        let bar = Bar::new(b.0, b.1, b.2, b.3, b.4, b.5 as u64);
        chart.add_bar(bar);
    }
    let bars = chart.bars();
    for b in bars {
        println!("{b}");
    }

    assert_eq!(bars.len(), 1);
    assert_eq!(
        bars[0],
        Bar::new(
            1735887540000000000_i64,
            280.0,
            280.41,
            278.11,
            278.73,
            5620260
        )
    );
}

fn bars() -> std::vec::Vec<(i64, f64, f64, f64, f64, i32)> {
    vec![
        (1735887540000000000_i64, 280.0, 280.0, 280.0, 280.0, 158150),
        (
            1735887600000000000_i64,
            279.99,
            280.0,
            279.55,
            279.7,
            476620,
        ),
        (
            1735887660000000000_i64,
            279.64,
            279.9,
            279.2,
            279.85,
            643880,
        ),
        (
            1735887720000000000_i64,
            279.85,
            280.41,
            279.74,
            280.1,
            584470,
        ),
        (
            1735887780000000000_i64,
            280.17,
            280.2,
            279.87,
            279.9,
            369760,
        ),
        (
            1735887840000000000_i64,
            279.9,
            279.95,
            279.54,
            279.54,
            338140,
        ),
        (
            1735887900000000000_i64,
            279.54,
            279.56,
            279.0,
            279.44,
            767470,
        ),
        (
            1735887960000000000_i64,
            279.43,
            279.44,
            278.58,
            278.91,
            520310,
        ),
        (
            1735888020000000000_i64,
            278.99,
            279.38,
            278.71,
            279.07,
            281490,
        ),
        (
            1735888080000000000_i64,
            279.07,
            279.07,
            278.11,
            278.31,
            304020,
        ),
        (
            1735888140000000000_i64,
            278.34,
            278.91,
            278.15,
            278.4,
            416040,
        ),
        (
            1735888200000000000_i64,
            278.53,
            278.89,
            278.14,
            278.62,
            233030,
        ),
        (
            1735888260000000000_i64,
            278.62,
            278.93,
            278.58,
            278.93,
            164140,
        ),
        (
            1735888320000000000_i64,
            278.91,
            279.21,
            278.85,
            278.86,
            208890,
        ),
        (
            1735888380000000000_i64,
            278.86,
            278.88,
            278.51,
            278.73,
            153850,
        ),
    ]
}
